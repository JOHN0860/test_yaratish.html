<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f4f6f9; margin: 0; padding: 10px; padding-bottom: 320px; }
        .container { background: white; border-radius: 15px; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h2 { text-align: center; color: #333; font-size: 18px; margin-bottom: 20px; }
        
        .q-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .q-num { width: 35px; font-weight: bold; color: #555; }
        .options { display: flex; gap: 8px; flex-wrap: wrap; }
        .opt { width: 36px; height: 36px; border: 2px solid #0088cc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: #0088cc; cursor: pointer; transition: 0.2s; }
        .opt.active { background: #0088cc; color: white; }

        .write-label { font-weight: bold; margin-top: 15px; display: block; color: #444; }
        .math-box { width: 100%; min-height: 45px; border: 2px solid #fbca04; border-radius: 8px; margin: 8px 0; display: flex; align-items: center; padding: 0 10px; font-size: 20px; background: #fffdf2; cursor: pointer; }
        .math-box.active-box { border-color: #0088cc; background: #f0faff; }

        /* Virtual Klaviatura */
        .kb-container { position: fixed; bottom: 0; left: 0; width: 100%; background: #d2d5db; padding: 8px; box-sizing: border-box; display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; box-shadow: 0 -2px 10px rgba(0,0,0,0.2); z-index: 9999; }
        .key { background: #fff; border: none; border-radius: 6px; padding: 12px 0; font-size: 17px; font-weight: bold; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .key:active { background: #ced4da; }
        .key-action { background: #a5abb6; color: white; }
        .btn-submit { grid-column: span 10; background: #0088cc; color: white; padding: 15px; border-radius: 10px; font-size: 18px; margin-top: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2 id="top-title">Mok Test (Milliy Sertifikat)</h2>
    <div id="test_id_section" style="display:none; margin-bottom:15px;">
        <input type="number" id="input_code" placeholder="Test kodini kiriting..." style="width:100%; padding:12px; border:1px solid #ccc; border-radius:8px; font-size:16px;">
    </div>
    
    <div id="questions-area"></div>
</div>

<div class="kb-container" id="keyboard">
    <button class="key" onclick="k('1')">1</button>
    <button class="key" onclick="k('2')">2</button>
    <button class="key" onclick="k('3')">3</button>
    <button class="key" onclick="k('4')">4</button>
    <button class="key" onclick="k('5')">5</button>
    <button class="key" onclick="k('6')">6</button>
    <button class="key" onclick="k('7')">7</button>
    <button class="key" onclick="k('8')">8</button>
    <button class="key" onclick="k('9')">9</button>
    <button class="key" onclick="k('0')">0</button>
    <button class="key" onclick="k('+')">+</button>
    <button class="key" onclick="k('-')">-</button>
    <button class="key" onclick="k('*')">*</button>
    <button class="key" onclick="k('/')">/</button>
    <button class="key" onclick="k(',')">,</button>
    <button class="key" onclick="k('‚àö')">‚àö</button>
    <button class="key" onclick="k('œÄ')">œÄ</button>
    <button class="key" onclick="k('(')">(</button>
    <button class="key" onclick="k(')')">)</button>
    <button class="key key-action" onclick="del()">‚å´</button>
    
    <button class="btn-submit" onclick="sendAll()">üì§ TASDIQLASH</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.expand();
    const mode = new URLSearchParams(window.location.search).get('mode');
    const answers = {};
    let curQ = 36;

    if(mode === 'check') {
        document.getElementById('test_id_section').style.display = 'block';
        document.getElementById('top-title').innerText = "üìù Javoblarni Tekshirish";
    }

    const area = document.getElementById('questions-area');

    // 1-32 Savollar (A-D)
    for(let i=1; i<=32; i++) createOptRow(i, ['A','B','C','D']);
    // 33-35 Savollar (A-F)
    for(let i=33; i<=35; i++) createOptRow(i, ['A','B','C','D','E','F']);
    // 36-45 Savollar (Virtual Klaviatura)
    for(let i=36; i<=45; i++) {
        const div = document.createElement('div');
        div.innerHTML = `<span class="write-label">${i}-savol (a):</span>
                         <div class="math-box" id="box-${i}" onclick="setQ(${i})"></div>`;
        area.appendChild(div);
    }

    function createOptRow(n, opts) {
        const row = document.createElement('div');
        row.className = 'q-row';
        row.innerHTML = `<div class="q-num">${n}.</div><div class="options">` + 
            opts.map(o => `<div class="opt" onclick="pick(${n},'${o}',this)">${o}</div>`).join('') + `</div>`;
        area.appendChild(row);
    }

    function pick(q, v, el) {
        el.parentElement.querySelectorAll('.opt').forEach(x => x.classList.remove('active'));
        el.classList.add('active');
        answers[q] = v;
    }

    function setQ(q) {
        curQ = q;
        document.querySelectorAll('.math-box').forEach(b => b.classList.remove('active-box'));
        document.getElementById('box-'+q).classList.add('active-box');
    }

    function k(v) {
        if(!answers[curQ]) answers[curQ] = "";
        answers[curQ] += v;
        document.getElementById('box-'+curQ).innerText = answers[curQ];
    }

    function del() {
        if(answers[curQ]) {
            answers[curQ] = answers[curQ].slice(0, -1);
            document.getElementById('box-'+curQ).innerText = answers[curQ];
        }
    }

    function sendAll() {
        let result = "";
        for(let i=1; i<=45; i++) result += (answers[i] || "?") + (i<45 ? "|" : "");
        
        if(mode === 'create') {
            tg.sendData(JSON.stringify({action:'create', keys: result}));
        } else {
            const code = document.getElementById('input_code').value;
            if(!code) return alert("Test kodini kiriting!");
            tg.sendData(JSON.stringify({action:'check', code: code, answers: result}));
        }
    }
    // Dastlabki aktiv katak
    setQ(36);
</script>
</body>
</html>
